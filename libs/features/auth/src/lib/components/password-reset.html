<!-- T120: Password Reset Template - Two modes (request | reset) -->
<div class="flex items-center justify-center min-h-screen bg-base-100 p-4">
  <div class="card w-full max-w-md bg-base-200 shadow-xl">
    <div class="card-body">
      <!-- T122: Success message (after reset request sent) -->
      @if (success() && mode() === 'request') {
      <div class="alert alert-success mb-4" role="alert">
        <ng-icon name="heroCheckCircle" size="32" class="shrink-0" />
        <div>
          <p class="font-semibold">Check your email</p>
          <p class="text-sm">We've sent you a password reset link</p>
        </div>
      </div>
      }

      <!-- Success message (after password updated) -->
      @if (success() && mode() === 'reset') {
      <div class="alert alert-success mb-4" role="alert">
        <ng-icon name="heroCheckCircle" size="32" class="shrink-0" />
        <div>
          <p class="font-semibold">Password updated!</p>
          <p class="text-sm">Redirecting to sign in...</p>
        </div>
      </div>
      }

      <!-- T125: Error Alert -->
      @if (error()) {
      <div class="alert alert-error mb-4" role="alert">
        <ng-icon name="heroXCircle" size="32" class="shrink-0" />
        <span>{{ error() }}</span>
      </div>
      }

      <!-- MODE: Request Reset Link (Step 1) -->
      @if (mode() === 'request') {
      <h2 class="card-title text-2xl font-bold mb-2">Reset Password</h2>
      <p class="text-base-content/70 mb-6">
        Enter your email address and we'll send you a link to reset your password.
      </p>

      <form
        [formGroup]="resetRequestForm"
        (ngSubmit)="onRequestReset()"
        [attr.aria-busy]="isLoading()"
      >
        <!-- T118: Email Input -->
        <div class="form-control w-full mb-6">
          <label class="label" for="reset-email-input">
            <span class="label-text">Email</span>
          </label>
          <label class="w-full input input-bordered flex items-center gap-2" [class.input-error]="emailInvalid">
            <ng-icon name="heroEnvelope" size="16" class="opacity-70" />
            <input
              id="reset-email-input"
              formControlName="email"
              type="email"
              placeholder="you@example.com"
              class="grow"
              [disabled]="isLoading()"
              [attr.aria-required]="true"
              [attr.aria-invalid]="emailInvalid"
              [attr.aria-describedby]="emailInvalid ? 'email-error' : null"
            />
          </label>
          @if (emailInvalid) {
          <label class="label">
            <span id="email-error" class="label-text-alt text-error mt-1 ml-2" role="alert">
              @if (resetRequestForm.controls.email.errors?.['required']) { Email is required } @if
              (resetRequestForm.controls.email.errors?.['email']) { Please enter a valid email
              address }
            </span>
          </label>
          }
        </div>

        <!-- T121: Submit Button with Loading State -->
        <button
          type="submit"
          class="btn btn-primary w-full mb-4"
          [disabled]="resetRequestForm.invalid || isLoading()"
          [attr.aria-label]="isLoading() ? 'Sending reset link...' : 'Send reset link'"
        >
          @if (isLoading()) {
          <span class="loading loading-spinner loading-sm"></span>
          } Send Reset Link
        </button>

        <!-- Back to Login Link -->
        <div class="text-center">
          <a routerLink="/auth/login" class="link link-primary text-sm inline-flex items-center gap-1">
            <ng-icon name="heroArrowLeft" size="16" />
            Back to Sign In
          </a>
        </div>
      </form>
      }

      <!-- MODE: Set New Password (Step 2) -->
      @if (mode() === 'reset') {
      <h2 class="card-title text-2xl font-bold mb-2">Set New Password</h2>
      <p class="text-base-content/70 mb-6">Choose a strong password for your account.</p>

      <form
        [formGroup]="newPasswordForm"
        (ngSubmit)="onUpdatePassword()"
        [attr.aria-busy]="isLoading()"
        class="space-y-4"
      >
        <!-- T119: New Password Input -->
        <div class="form-control w-full">
          <label class="label" for="new-password-input">
            <span class="label-text">New Password</span>
          </label>
          <label class="w-full input input-bordered flex items-center gap-2" [class.input-error]="newPasswordInvalid">
            <ng-icon name="heroKey" size="16" class="opacity-70" />
            <input
              id="new-password-input"
              formControlName="newPassword"
              type="password"
              placeholder="••••••••"
              class="grow"
              [disabled]="isLoading()"
              [attr.aria-required]="true"
              [attr.aria-invalid]="newPasswordInvalid"
              [attr.aria-describedby]="newPasswordInvalid ? 'new-password-error' : null"
            />
          </label>
          @if (newPasswordInvalid) {
          <label class="label">
            <span id="new-password-error" class="label-text-alt text-error mt-1 ml-2" role="alert">
              @if (newPasswordForm.controls.newPassword.errors?.['required']) { Password is required
              } @if (newPasswordForm.controls.newPassword.errors?.['minlength']) { Password must be
              at least 8 characters } @if (passwordErrors?.['passwordStrength']) { Password must
              contain at least one letter and one number }
            </span>
          </label>
          }
        </div>

        <!-- Confirm Password Input -->
        <div class="form-control w-full">
          <label class="label" for="confirm-password-input">
            <span class="label-text">Confirm Password</span>
          </label>
          <label class="w-full input input-bordered flex items-center gap-2" [class.input-error]="confirmPasswordInvalid">
            <ng-icon name="heroKey" size="16" class="opacity-70" />
            <input
              id="confirm-password-input"
              formControlName="confirmPassword"
              type="password"
              placeholder="••••••••"
              class="grow"
              [disabled]="isLoading()"
              [attr.aria-required]="true"
              [attr.aria-invalid]="confirmPasswordInvalid"
              [attr.aria-describedby]="confirmPasswordInvalid ? 'confirm-password-error' : null"
            />
          </label>
          @if (confirmPasswordInvalid) {
          <label class="label">
            <span id="confirm-password-error" class="label-text-alt text-error mt-1 ml-2" role="alert">
              @if (newPasswordForm.controls.confirmPassword.errors?.['required']) { Please confirm
              your password }
            </span>
          </label>
          }
        </div>

        <!-- T124: Submit Button with Loading State -->
        <button
          type="submit"
          class="btn btn-primary w-full"
          [disabled]="newPasswordForm.invalid || isLoading()"
          [attr.aria-label]="isLoading() ? 'Updating password...' : 'Update password'"
        >
          @if (isLoading()) {
          <span class="loading loading-spinner loading-sm"></span>
          } Update Password
        </button>
      </form>
      }
    </div>
  </div>
</div>
