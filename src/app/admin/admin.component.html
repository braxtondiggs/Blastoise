<mat-toolbar color="primary" *ngIf="isLoggedIn()" class="elevated-toolbar">
  <mat-toolbar-row>
    <a [routerLink]="['/']" class="flex-row flex-align-start-center flex-gap-8 logo-link">
      <img src="/assets/icons/icon-72x72.png" alt="Blastoise Logo" />
      <span class="app-title">{{title()}}</span>
    </a>
    <span class="spacer"></span>
    <div class="toolbar-actions">
      <button mat-icon-button *ngIf="(reviews$ | async) as reviews" (click)="openReviews(reviews)"
              matTooltip="View Reviews" class="notification-btn">
        <mat-icon [matBadge]="reviews.length" [matBadgeHidden]="reviews.length === 0"
                  matBadgeColor="warn" matBadgeSize="small">notifications</mat-icon>
      </button>
    </div>
  </mat-toolbar-row>
</mat-toolbar>
<div class="admin-container" *ngIf="isLoggedIn()">
  <!-- Header Section with Stats using Material elevation -->
  <div class="header-section">
    <div class="stats-cards">
      <mat-card class="stat-card" appearance="raised">
        <mat-card-content>
          <div class="stat-content">
            <mat-icon class="stat-icon" color="primary">local_bar</mat-icon>
            <div class="stat-text">
              <span class="stat-number">{{dataSource.data.length}}</span>
              <span class="stat-label">Total Breweries</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card" appearance="raised">
        <mat-card-content>
          <div class="stat-content">
            <mat-icon class="stat-icon" color="accent">timeline</mat-icon>
            <div class="stat-text">
              <span class="stat-number">{{getTotalVisits()}}</span>
              <span class="stat-label">Total Visits</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <!-- Simple Controls Section -->
  <div class="controls-section">
    <div class="simple-controls">
      <button mat-raised-button
              color="primary"
              (click)="addBrewery()"
              class="control-btn add-btn">
        <mat-icon>add</mat-icon>
        Add Brewery
      </button>

      <button mat-stroked-button
              (click)="refresh()"
              class="control-btn refresh-btn">
        <mat-icon>refresh</mat-icon>
        Refresh
      </button>
    </div>
  </div>
  <!-- Data Table using Material elevation -->
  <div class="table-section">
    <mat-card class="table-card" appearance="outlined">
      <!-- Search Header using Material form field -->
      <div class="table-header-controls">
        <div class="search-container">
          <mat-form-field appearance="outline" class="search-field" subscriptSizing="dynamic">
            <mat-label>Search breweries</mat-label>
            <input matInput
                   (keyup)="applyFilter($event)"
                   placeholder="Search by name, location, or notes..."
                   #input
                   autocomplete="off">
            <mat-icon matPrefix>search</mat-icon>
            <button mat-icon-button
                    matSuffix
                    *ngIf="input.value"
                    (click)="clearSearch(input)"
                    matTooltip="Clear search">
              <mat-icon>close</mat-icon>
            </button>
          </mat-form-field>
        </div>
      </div>

      <div class="table-container">
        <table mat-table matSort multiTemplateDataRows [dataSource]="dataSource"
               class="modern-table" matSortDirection="desc" matSortActive="date">

          <!-- Enhanced Name Column with Status Indicators -->
          <ng-container matColumnDef="name">
            <th mat-header-cell mat-sort-header *matHeaderCellDef class="name-header">
              <div class="header-content">
                <mat-icon>local_bar</mat-icon>
                <span>Brewery</span>
              </div>
            </th>
            <td mat-cell *matCellDef="let element" class="name-cell">
              <div class="brewery-info">
                <div class="brewery-main">
                  <span class="brewery-name">{{element.name}}</span>
                  <div class="brewery-badges">
                    <!-- Visit count chip using Material design -->
                    <mat-chip-set>
                      <mat-chip *ngIf="element.timeline !== undefined"
                               [color]="getVisitChipColor(element.timeline)"
                               class="visit-chip">
                        <mat-icon matChipAvatar>timeline</mat-icon>
                        {{element.timeline}} visit{{element.timeline !== 1 ? 's' : ''}}
                      </mat-chip>

                      <!-- Recent visit chip -->
                      <mat-chip *ngIf="element.lastUpdated && isRecentVisit(element.lastUpdated)"
                               color="accent"
                               matTooltip="Visited in the last 30 days">
                        <mat-icon matChipAvatar>schedule</mat-icon>
                        Recent
                      </mat-chip>

                      <!-- Favorite chip -->
                      <mat-chip *ngIf="element.timeline && element.timeline > 5"
                               color="warn"
                               matTooltip="Favorite brewery">
                        <mat-icon matChipAvatar>favorite</mat-icon>
                        Favorite
                      </mat-chip>
                    </mat-chip-set>
                  </div>
                </div>

                <!-- Secondary info -->
                <div class="brewery-meta" *ngIf="element.address">
                  <span class="address">
                    <mat-icon>location_on</mat-icon>
                    {{element.address}}
                  </span>
                </div>
              </div>
            </td>
          </ng-container>

          <!-- Enhanced Date Column with Visual Indicators -->
          <ng-container matColumnDef="date">
            <th mat-header-cell mat-sort-header *matHeaderCellDef class="date-header">
              <div class="header-content">
                <mat-icon>schedule</mat-icon>
                <span>Last Visit</span>
              </div>
            </th>
            <td mat-cell *matCellDef="let element" class="date-cell">
              <div class="date-info" *ngIf="element.updated; else noDate">
                <div class="date-main">
                  <span class="date-primary">{{ element.updated }}</span>
                  <div class="date-indicator"
                       [class.recent]="element.lastUpdated && isRecentVisit(element.lastUpdated)"
                       [class.old]="element.lastUpdated && !isRecentVisit(element.lastUpdated)"
                       *ngIf="element.lastUpdated">
                  </div>
                </div>
                <span class="date-relative">{{ getRelativeTime(element.lastUpdated) }}</span>
              </div>
              <ng-template #noDate>
                <div class="no-date">
                  <mat-icon>do_not_disturb</mat-icon>
                  <span>Never visited</span>
                </div>
              </ng-template>
            </td>
          </ng-container>

          <!-- Enhanced Actions Column with Quick Actions -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef class="actions-header">
              <span>Quick Actions</span>
            </th>
            <td mat-cell *matCellDef="let element" class="actions-cell">
              <div class="action-buttons">
                <!-- Primary action: Add visit -->
                <button mat-mini-fab
                        color="primary"
                        (click)="addTimeline(element); $event.stopPropagation()"
                        matTooltip="Add new visit"
                        class="action-btn primary-action">
                  <mat-icon>add</mat-icon>
                </button>

                <!-- Secondary actions menu -->
                <button mat-icon-button
                        [matMenuTriggerFor]="actionsMenu"
                        (click)="$event.stopPropagation()"
                        matTooltip="More actions"
                        class="action-btn secondary-action">
                  <mat-icon>more_vert</mat-icon>
                </button>

                <mat-menu #actionsMenu="matMenu">
                  <button mat-menu-item (click)="editBrewery(element)">
                    <mat-icon>edit</mat-icon>
                    <span>Edit Details</span>
                  </button>
                  <button mat-menu-item (click)="viewLocation(element)">
                    <mat-icon>map</mat-icon>
                    <span>View on Map</span>
                  </button>
                  <button mat-menu-item (click)="copyLocation(element)">
                    <mat-icon>content_copy</mat-icon>
                    <span>Copy Address</span>
                  </button>
                  <mat-divider></mat-divider>
                  <button mat-menu-item
                          (click)="removeBrewery(element.placeId)"
                          *ngIf="!element.timeline || element.timeline === 0"
                          class="delete-action">
                    <mat-icon>delete</mat-icon>
                    <span>Delete Brewery</span>
                  </button>
                </mat-menu>
              </div>
            </td>
          </ng-container>

          <!-- Enhanced Expandable Detail Row -->
          <ng-container matColumnDef="expandedDetail">
            <td mat-cell *matCellDef="let element" [attr.colspan]="columns.length" class="detail-cell">
              <div class="timeline-section" [@detailExpand]="element === expandedElement() ? 'expanded' : 'collapsed'">
                <div *ngIf="(timeline$ | async) as timeline; else noTimeline" class="timeline-container">
                  <div class="timeline-header">
                    <h3>
                      <mat-icon>timeline</mat-icon>
                      Visit History
                    </h3>
                    <span class="visit-count">{{timeline.length}} visit{{timeline.length !== 1 ? 's' : ''}}</span>
                  </div>

                  <div class="timeline-list">
                    <div *ngFor="let item of timeline; let i = index" class="timeline-item">
                      <div class="timeline-marker">
                        <mat-icon>event</mat-icon>
                      </div>
                      <div class="timeline-content">
                        <div class="timeline-title">{{timelineDisplay[i]?.title}}</div>
                        <div class="timeline-time">
                          <span class="time-range">
                            {{timelineDisplay[i]?.start}}
                            <span *ngIf="timelineDisplay[i]?.end"> - {{timelineDisplay[i]?.end}}</span>
                          </span>
                          <span *ngIf="timelineDisplay[i]?.duration" class="duration">
                            â€¢ {{timelineDisplay[i]?.duration}}
                          </span>
                        </div>
                      </div>
                      <div class="timeline-actions">
                        <button mat-icon-button [matMenuTriggerFor]="menu" class="timeline-menu-btn">
                          <mat-icon>more_vert</mat-icon>
                        </button>
                        <mat-menu #menu="matMenu">
                          <button mat-menu-item (click)="modifyTimeline(element, item, timeline)">
                            <mat-icon>edit</mat-icon>
                            <span>Edit Visit</span>
                          </button>
                          <button mat-menu-item (click)="addTimeline(element)">
                            <mat-icon>add</mat-icon>
                            <span>Add Visit</span>
                          </button>
                          <button mat-menu-item (click)="removeTimeline(element, item, timeline)" class="delete-item">
                            <mat-icon>delete</mat-icon>
                            <span>Delete Visit</span>
                          </button>
                        </mat-menu>
                      </div>
                    </div>
                  </div>
                </div>

                <ng-template #noTimeline>
                  <div class="no-timeline">
                    <mat-icon>timeline</mat-icon>
                    <p>No visits recorded for this brewery</p>
                    <button mat-stroked-button color="primary" (click)="addTimeline(element)">
                      <mat-icon>add</mat-icon>
                      Add First Visit
                    </button>
                  </div>
                </ng-template>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="columns; sticky: true" class="table-header"></tr>
          <tr mat-row *matRowDef="let element; columns: columns;"
              (click)="getExpandedElement(element)"
              class="table-row"
              [class.expanded]="element === expandedElement()"></tr>
          <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="detail-row"></tr>

          <!-- Enhanced No Data Row -->
          <tr class="no-data-row" *matNoDataRow>
            <td class="no-data-cell" colspan="4">
              <div class="no-data-content">
                <mat-icon>search_off</mat-icon>
                <h4>No breweries found</h4>
                <p *ngIf="dataSource.filter; else noBreweries">
                  No breweries match your search
                </p>
                <ng-template #noBreweries>
                  <p>Start by adding your first brewery</p>
                  <button mat-raised-button color="primary" (click)="addBrewery()">
                    <mat-icon>add</mat-icon>
                    Add Brewery
                  </button>
                </ng-template>
              </div>
            </td>
          </tr>
        </table>
      </div>

      <!-- Enhanced Paginator -->
      <mat-paginator [pageSizeOptions]="[15, 25, 50, 100]"
                     showFirstLastButtons
                     class="table-paginator">
      </mat-paginator>
    </mat-card>
  </div>

  <!-- Floating Action Button -->
  <div class="fab-container">
    <button mat-fab color="primary" (click)="openQuickActions()" class="main-fab" matTooltip="Quick Actions">
      <mat-icon>add</mat-icon>
    </button>
  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" *ngIf="isLoading()">
    <div class="loading-content">
      <mat-spinner color="primary" diameter="60"></mat-spinner>
      <p>Loading...</p>
    </div>
  </div>
</div>

<!-- Auth Required Message -->
<div class="auth-required" *ngIf="!isLoggedIn() && !isLoading()">
  <mat-card class="auth-card">
    <mat-card-content>
      <div class="auth-content">
        <mat-icon class="auth-icon">lock</mat-icon>
        <h2>Authentication Required</h2>
        <p>Please log in to access the admin panel</p>
        <button mat-raised-button color="primary" (click)="getAuth()">
          <mat-icon>login</mat-icon>
          Log In
        </button>
      </div>
    </mat-card-content>
  </mat-card>
</div>
