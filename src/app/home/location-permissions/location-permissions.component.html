<div mat-dialog-title>Background Location Tracking</div>

<div mat-dialog-content>
  <!-- Status Chips -->
  <div class="status-chips">
    <mat-chip-set>
      <mat-chip [highlighted]="hasPermission()">
        <mat-icon matChipAvatar>{{ getPermissionStatusIcon() }}</mat-icon>
        {{ getPermissionStatusText() }}
      </mat-chip>
      <mat-chip [highlighted]="isTracking()">
        <mat-icon matChipAvatar>{{
          isTracking() ? "radio_button_checked" : "radio_button_unchecked"
        }}</mat-icon>
        {{ isTracking() ? "Tracking Active" : "Tracking Inactive" }}
      </mat-chip>
    </mat-chip-set>
  </div>

  <!-- Permission Request Section -->
  <div *ngIf="isPermissionDenied() && !hasPermission()" class="denied-card">
    <mat-icon color="warn">warning</mat-icon>
    <h4>Location Access Denied</h4>
  </div>

  <mat-divider *ngIf="hasPermission()"></mat-divider>

  <!-- Settings Form -->
  <form [formGroup]="settingsForm" *ngIf="hasPermission()">
    <mat-list>
      <mat-list-item>
        <mat-slide-toggle
          matListItemMeta
          formControlName="enabled"
          (change)="onTrackingToggle($event.checked)"
          [disabled]="isRequesting()"
        >
        </mat-slide-toggle>
        <div matListItemTitle>Enable Background Tracking</div>
      </mat-list-item>
    </mat-list>

    <mat-expansion-panel *ngIf="settingsForm.get('enabled')?.value">
      <mat-expansion-panel-header>
        <mat-panel-title>Advanced Settings</mat-panel-title>
      </mat-expansion-panel-header>

      <mat-form-field appearance="outline">
        <mat-label>Tracking Frequency</mat-label>
        <mat-select formControlName="trackingInterval">
          <mat-option
            *ngFor="let interval of trackingIntervals"
            [value]="interval.value"
          >
            {{ interval.label }}
          </mat-option>
        </mat-select>
        <mat-hint>How often to update your location</mat-hint>
      </mat-form-field>

      <mat-list>
        <mat-list-item>
          <mat-slide-toggle
            matListItemMeta
            formControlName="highAccuracy"
          ></mat-slide-toggle>
          <div matListItemTitle>High Accuracy Mode</div>
          <div matListItemLine>
            Use GPS for precise location (may drain battery)
          </div>
        </mat-list-item>
        <mat-list-item>
          <mat-slide-toggle
            matListItemMeta
            formControlName="significantChangeOnly"
          ></mat-slide-toggle>
          <div matListItemTitle>Significant Change Only</div>
          <div matListItemLine>
            Update only when you move significantly (saves battery)
          </div>
        </mat-list-item>
      </mat-list>
    </mat-expansion-panel>
  </form>
</div>

<div mat-dialog-actions>
  <button
    mat-raised-button
    color="primary"
    *ngIf="canRequestPermission()"
    (click)="requestPermissions()"
    [disabled]="isRequesting()"
  >
    <mat-icon>location_on</mat-icon>
    Enable Location Access
  </button>
  <button
    mat-button
    (click)="getCurrentLocation()"
    [disabled]="isRequesting()"
    *ngIf="hasPermission()"
  >
    <mat-icon>my_location</mat-icon>
    Test Location
  </button>
  <button
    mat-button
    (click)="syncLocationData()"
    [disabled]="isRequesting()"
    *ngIf="hasPermission()"
  >
    <mat-icon>sync</mat-icon>
    Sync Data
  </button>
  <div class="spacer"></div>
  <button mat-button (click)="closeDialog()" cdkFocusInitial>
    <mat-icon>close</mat-icon>
    Close
  </button>
  <mat-spinner *ngIf="isRequesting()" diameter="20"></mat-spinner>
</div>
