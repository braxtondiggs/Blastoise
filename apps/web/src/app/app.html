@if (!isAuthInitialized) {
  <!-- Loading state while auth initializes -->
  <div class="flex items-center justify-center min-h-screen bg-base-100">
    <div class="text-center">
      <span class="loading loading-spinner loading-lg text-primary"></span>
      <p class="mt-4 text-base-content/70">Loading...</p>
    </div>
  </div>
} @else if (isAuthenticated) {
  <div class="flex flex-col min-h-screen bg-base-100">
    <header class="sticky top-0 z-50 border-b border-base-300/50 bg-base-100/80 backdrop-blur-md">
      <div class="w-full max-w-4xl px-4 mx-auto h-16 flex items-center justify-between">
        <a
          (click)="navigateTo('/visits')"
          class="flex items-center gap-3 cursor-pointer group"
        >
          <div class="relative">
            <img src="/assets/icons/icon-72x72.png" alt="Blastoise Logo" class="w-9 h-9 rounded-lg" />
          </div>
          <div class="flex flex-col">
            <span class="text-lg font-bold leading-tight group-hover:text-primary transition-colors">{{ title }}</span>
            <span class="text-[11px] text-base-content/50 hidden sm:block">Drink responsibly, track obsessively.</span>
          </div>
        </a>

        <div class="relative">
          <button
            type="button"
            class="flex items-center justify-center w-10 h-10 rounded-xl hover:bg-base-200 transition-colors"
            (click)="toggleDropdown(); $event.stopPropagation()"
            [attr.aria-expanded]="isDropdownOpen()"
            aria-haspopup="true"
            aria-label="Navigation menu"
          >
            @if (isDropdownOpen()) {
              <ng-icon name="heroXMark" size="22" />
            } @else {
              <ng-icon name="heroBars3" size="22" />
            }
          </button>

          @if (isDropdownOpen()) {
            <ul
              class="absolute right-0 z-[1200] w-52 p-1.5 mt-2 shadow-xl border border-base-300/50 menu bg-base-100 rounded-xl"
              role="menu"
              aria-label="Navigation options"
            >
              <li role="menuitem">
                <button
                  type="button"
                  (click)="navigateTo('/visits')"
                  class="flex items-center gap-3 rounded-lg"
                  [class.active]="isActiveRoute('visits')"
                >
                  <ng-icon name="heroHome" size="18" />
                  My Visits
                </button>
              </li>

              <li role="menuitem">
                <button
                  type="button"
                  (click)="navigateTo('/settings')"
                  class="flex items-center gap-3 rounded-lg"
                  [class.active]="isActiveRoute('settings')"
                >
                  <ng-icon name="heroCog6Tooth" size="18" />
                  Settings
                </button>
              </li>

              <div class="my-1.5 border-t border-base-300/50"></div>

              <li role="menuitem">
                <button
                  type="button"
                  (click)="onSignOut()"
                  class="flex items-center gap-3 rounded-lg text-error hover:bg-error/10"
                >
                  <ng-icon name="heroArrowRightOnRectangle" size="18" />
                  Sign Out
                </button>
              </li>
            </ul>
          }
        </div>
      </div>
    </header>

    <!-- Web Limitation Notice (Web Only, After Login) -->
    @if (showWebNotice()) {
      <div class="p-4 pb-0">
        <lib-web-limitation-notice />
      </div>
    }

    <!-- Location Permission Notice (When geolocation is disabled) -->
    @if (showLocationNotice()) {
      <div class="p-4 pb-0">
        <lib-location-permission-notice />
      </div>
    }

    <!-- Page content -->
    <main class="flex-1">
      <router-outlet></router-outlet>
    </main>
  </div>
} @else {
  <!-- Unauthenticated view -->
  <router-outlet></router-outlet>
}
